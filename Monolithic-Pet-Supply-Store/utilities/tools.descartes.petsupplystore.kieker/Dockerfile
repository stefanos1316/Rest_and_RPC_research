FROM descartesresearch/petsupplystore-base:latest
MAINTAINER Chair of Software Engineering <se2-it@informatik.uni-wuerzburg.de>

EXPOSE 8080

WORKDIR /opt

RUN mkdir /opt/kieker && mkdir /opt/kieker/config && mkdir /opt/kieker/aop

COPY aop.xml /opt/kieker/aop/aop.xml
RUN  mkdir -p /usr/local/tomcat/lib/META-INF
COPY aop.xml /usr/local/tomcat/lib/META-INF/
COPY kieker.monitoring.properties /opt/kieker/config/kieker.monitoring.properties
COPY src/main/webapp/WEB-INF/lib/kieker-1.14-SNAPSHOT-aspectj.jar /opt/kieker/agent/agent.jar
COPY target/*.war /usr/local/tomcat/webapps/

RUN \
  mkdir -p /opt/kieker/agent && \
  mkdir -p /opt/kieker/logs && \
  ln -s /usr/local/tomcat/webapps /opt/kieker/webapps && \
  sed -i '250i\'"export KIEKER_JAVA_OPTS=\" \
    -javaagent:/opt/kieker/agent/agent.jar \
    -Dkieker.monitoring.configuration=/opt/kieker/config/kieker.monitoring.properties \
    -Dkieker.monitoring.writer.filesystem.AsciiFileWriter.customStoragePath=/opt/kieker/logs \
    -Daj.weaving.verbose=true \
    -Dorg.aspectj.weaver.loadtime.configuration=/opt/kieker/aop/aop.xml \
    -Dkieker.monitoring.skipDefaultAOPConfiguration=true \
    \"" /usr/local/tomcat/bin/catalina.sh && \
  sed -i '251i\'"export JAVA_OPTS=\"\${KIEKER_JAVA_OPTS} \${JAVA_OPTS}\"" /usr/local/tomcat/bin/catalina.sh
  
  
CMD \
  /usr/local/tomcat/bin/start.sh && \
  /usr/local/tomcat/bin/catalina.sh run

VOLUME ["/opt/kieker"]